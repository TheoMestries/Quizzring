<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quizzring | Épreuve jaquettes</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <main class="page">
    <header class="header">
      <div>
        <p class="eyebrow">Épreuve visuelle</p>
        <h1>Jaquettes pixelisées</h1>
        <p class="subtitle">Chaque jaquette est d'abord pixelisée puis se révèle progressivement. Clique pour passer à une nouvelle jaquette.</p>
      </div>
      <a class="back" href="../index.html">← Retour à l'accueil</a>
    </header>

    <section class="board" aria-labelledby="cover-title">
      <div class="board-header">
        <div>
          <p class="eyebrow">Aperçu</p>
          <h2 id="cover-title">Jaquette en cours</h2>
        </div>
        <button id="next-cover" class="primary">Nouvelle jaquette</button>
      </div>

      <div class="cover-frame">
        <canvas id="cover-canvas" class="cover" aria-label="Jaquette mystère"></canvas>
      </div>

      <div class="pixel-controls" aria-label="Réglages de pixelisation">
        <label for="pixel-size">Taille des pixels :</label>
        <input type="range" id="pixel-size" min="2" max="60" value="28">
        <span id="pixel-value">28</span> px
        <button id="reveal" class="ghost">Relancer la révélation</button>
      </div>

      <p class="hint">Astuce : le curseur contrôle instantanément la pixelisation. Le bouton relance l'animation de dépixelisation pour la jaquette affichée.</p>
    </section>
  </main>

  <script>
    const covers = [
      "Image/Ark.jpg",
      "Image/RDR2.jpg",
      "Image/Halo.jpg",
      "Image/Minecraft.jpg",
      "Image/Fortnite.jpg",
      "Image/Celeste.jpg",
      "Image/RocketLeague.jpg",
      "Image/Horizon.jpg",
      "Image/Apex.jpg",
      "Image/DBD.jpg",
      "Image/clair-obscure.jpg",
      "Image/Mario_Odyssey.jpg",
      "Image/ResidentEvil.jpg",
      "Image/LoL.jpg",
      "Image/TLOU.jpg",
      "Image/HollowKnight.jpg",
      "Image/Overwatch.jpg",
      "Image/GTAV.jpg",
      "Image/StardewValley.jpg",
      "Image/FinalFantasy7.jpg"
    ];

    const coverCanvas = document.getElementById("cover-canvas");
    const canvasCtx = coverCanvas.getContext("2d");
    const pixelSlider = document.getElementById("pixel-size");
    const pixelValue = document.getElementById("pixel-value");
    const nextButton = document.getElementById("next-cover");
    const revealButton = document.getElementById("reveal");

    const img = new Image();
    img.crossOrigin = "anonymous";

    let currentIndex = 0;
    let revealInterval = null;

    function drawPixelated(pixelSize) {
      if (!img.complete || !img.naturalWidth || !img.naturalHeight) return;

      const w = img.naturalWidth;
      const h = img.naturalHeight;

      coverCanvas.width = w;
      coverCanvas.height = h;

      const tempCanvas = document.createElement("canvas");
      const tempCtx = tempCanvas.getContext("2d");

      const smallW = Math.max(1, Math.floor(w / pixelSize));
      const smallH = Math.max(1, Math.floor(h / pixelSize));

      tempCanvas.width = smallW;
      tempCanvas.height = smallH;

      tempCtx.imageSmoothingEnabled = false;
      canvasCtx.imageSmoothingEnabled = false;

      tempCtx.drawImage(img, 0, 0, smallW, smallH);

      canvasCtx.clearRect(0, 0, w, h);
      canvasCtx.drawImage(tempCanvas, 0, 0, smallW, smallH, 0, 0, w, h);
    }

    function updatePixelSize(newSize) {
      pixelValue.textContent = newSize;
      drawPixelated(newSize);
    }

    function startRevealAnimation() {
      if (revealInterval) {
        clearInterval(revealInterval);
      }

      let size = Math.max(parseInt(pixelSlider.value, 10), 2);
      updatePixelSize(size);

      revealInterval = setInterval(() => {
        size = Math.max(2, size - 2);
        pixelSlider.value = size;
        updatePixelSize(size);

        if (size <= 2) {
          clearInterval(revealInterval);
          revealInterval = null;
        }
      }, 220);
    }

    function showCover() {
      if (currentIndex >= covers.length) return;
      const newCover = covers[currentIndex];
      nextButton.disabled = false;
      nextButton.textContent = "Nouvelle jaquette";
      nextButton.classList.remove("primary-disabled");

      pixelSlider.value = 28;
      updatePixelSize(28);

      img.src = newCover;
      currentIndex += 1;

      if (currentIndex >= covers.length) {
        nextButton.disabled = true;
        nextButton.textContent = "Toutes les jaquettes";
        nextButton.classList.add("primary-disabled");
      }
    }

    img.addEventListener("load", startRevealAnimation);
    pixelSlider.addEventListener("input", (event) => {
      const value = parseInt(event.target.value, 10);
      updatePixelSize(value);
    });
    nextButton.addEventListener("click", showCover);
    revealButton.addEventListener("click", startRevealAnimation);

    showCover();
  </script>
</body>
</html>
