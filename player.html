<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quizzring | Salle d'attente</title>
  <link rel="stylesheet" href="multiplayer.css">
</head>
<body>
  <main class="page">
    <header class="header">
      <div>
        <p class="eyebrow">Joueurs</p>
        <h1>Salle d'attente Discord</h1>
        <p class="subtitle">Connecte-toi avec ton pseudo Discord, garde l'onglet ouvert et attends le lancement de l'admin.</p>
      </div>
      <a class="btn-ghost" href="index.html">← Retour</a>
    </header>

    <section class="grid" aria-label="Connexion joueur">
      <div>
        <p class="eyebrow">Profil</p>
        <h2 class="card-title">Connexion Discord</h2>
        <p class="lead">Clique sur le bouton ci-dessous : Discord te demandera l'autorisation d'accéder à ton profil.</p>
        <div class="stack">
          <button id="discord-login" class="btn-primary">Me connecter</button>
          <p id="discord-hint" class="hint"></p>
        </div>
      </div>

      <div class="stack" aria-live="polite">
        <p class="eyebrow">Statut perso</p>
        <h2 class="card-title">Ton statut</h2>
        <div id="player-card" class="player-row" style="display:none"></div>
        <p id="player-hint" class="lead">Rejoins pour apparaître dans la liste des joueurs.</p>
        <div class="stack">
          <p class="eyebrow">Partie</p>
          <div id="game-status" class="badge waiting">En attente</div>
          <p id="game-name" class="lead">Aucune partie lancée</p>
        </div>
      </div>
    </section>

    <section aria-label="Joueurs connectés">
      <p class="eyebrow">Participants</p>
      <h2 class="card-title">Joueurs en ligne</h2>
      <p class="lead">La liste est partagée via le navigateur. Ouvre cette page dans plusieurs onglets pour tester.</p>
      <div id="players" class="players" aria-live="polite"></div>
    </section>
  </main>

  <script src="multiplayer.js"></script>
  <script>
    const urlClientId = new URLSearchParams(window.location.search).get("client_id");
    const DISCORD_CLIENT_ID = urlClientId || "VOTRE_CLIENT_ID_DISCORD";
    const DISCORD_SCOPES = ["identify"];
    const DISCORD_AUTHORIZE_URL = "https://discord.com/oauth2/authorize";
    const discordButton = document.getElementById("discord-login");
    const discordHint = document.getElementById("discord-hint");
    const playerCard = document.getElementById("player-card");
    const playerHint = document.getElementById("player-hint");
    const gameStatus = document.getElementById("game-status");
    const gameName = document.getElementById("game-name");
    const playersList = document.getElementById("players");

    function buildRedirectUri() {
      return `${window.location.origin}${window.location.pathname}`;
    }

    function buildAuthorizeUrl() {
      const params = new URLSearchParams({
        client_id: DISCORD_CLIENT_ID,
        response_type: "token",
        redirect_uri: buildRedirectUri(),
        scope: DISCORD_SCOPES.join(" "),
        prompt: "consent",
      });
      return `${DISCORD_AUTHORIZE_URL}?${params.toString()}`;
    }

    function parseHashParams() {
      const hash = window.location.hash?.replace(/^#/, "");
      return new URLSearchParams(hash || "");
    }

    function cleanHash() {
      history.replaceState(null, document.title, window.location.pathname + window.location.search);
    }

    async function fetchDiscordProfile(accessToken) {
      const response = await fetch("https://discord.com/api/users/@me", {
        headers: {
          Authorization: `Bearer ${accessToken}`,
        },
      });

      if (!response.ok) {
        throw new Error("Impossible de récupérer le profil Discord");
      }

      return response.json();
    }

    function buildAvatarUrl(user) {
      if (user.avatar) {
        return `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png`;
      }
      return `https://cdn.discordapp.com/embed/avatars/${(user.discriminator || 0) % 5}.png`;
    }

    async function handleDiscordRedirect() {
      const params = parseHashParams();
      const accessToken = params.get("access_token");
      const tokenType = params.get("token_type");
      const isIdentify = params.get("scope")?.includes("identify");

      if (!accessToken || tokenType !== "Bearer" || !isIdentify) return;

      try {
        const profile = await fetchDiscordProfile(accessToken);
        quizzringState.upsertPlayer({
          name: profile.global_name || profile.username,
          avatar: buildAvatarUrl(profile),
        });
        quizzringState.refreshPresence();
      } catch (error) {
        alert(error.message || "Connexion Discord échouée");
      } finally {
        cleanHash();
      }
    }

    function setupDiscordButton() {
      discordHint.textContent = "Tu seras redirigé sur Discord pour autoriser la connexion.";
      discordButton.addEventListener("click", () => {
        const authorizeUrl = buildAuthorizeUrl();

        if (!DISCORD_CLIENT_ID || DISCORD_CLIENT_ID.includes("VOTRE_CLIENT_ID_DISCORD")) {
          alert(
            "Configure le Client ID Discord dans le fichier ou passe-le dans l'URL (paramètre client_id) pour activer la redirection."
          );
          return;
        }

        window.location.href = authorizeUrl;
      });
    }

    function renderGame(game) {
      if (game.status === "running") {
        gameStatus.textContent = "La partie est en cours";
        gameStatus.className = "badge running";
        gameName.textContent = game.name || "Partie surprise";
      } else {
        gameStatus.textContent = "En attente";
        gameStatus.className = "badge waiting";
        gameName.textContent = "Aucune partie lancée";
      }
    }

    function renderPlayers(players, currentId) {
      playersList.innerHTML = "";
      if (!players.length) {
        playersList.innerHTML = "<p class=\"lead\">Aucun joueur pour l'instant.</p>";
        return;
      }

      const fragment = document.createDocumentFragment();
      players
        .sort((a, b) => a.name.localeCompare(b.name))
        .forEach((player) => {
          const row = document.createElement("div");
          row.className = "player-row";
          const isCurrent = player.id === currentId;
          row.innerHTML = `
            <img class="avatar" src="${player.avatar}" alt="Avatar ${player.name}">
            <div class="stack">
              <p class="player-name">${player.name}${isCurrent ? " (toi)" : ""}</p>
              <p class="player-meta">${player.status === "in-game" ? "En jeu" : "En attente"} · ${quizzringState.formatSince(player.lastSeen)}</p>
            </div>
          `;
          fragment.appendChild(row);
        });
      playersList.appendChild(fragment);
    }

    function renderCurrentPlayer(state) {
      const currentId = quizzringState.getCurrentPlayerId();
      const current = currentId ? state.players.find((p) => p.id === currentId) : null;

      if (!current) {
        playerCard.style.display = "none";
        playerHint.style.display = "block";
        return;
      }

      playerCard.style.display = "flex";
      playerHint.style.display = "none";
      playerCard.innerHTML = `
        <img class="avatar" src="${current.avatar}" alt="Avatar ${current.name}">
        <div class="stack">
          <p class="player-name">${current.name}</p>
          <p class="player-meta">${current.status === "in-game" ? "En jeu" : "En attente"}</p>
        </div>
      `;
    }

    quizzringState.subscribe((state) => {
      renderGame(state.game);
      renderPlayers(state.players, quizzringState.getCurrentPlayerId());
      renderCurrentPlayer(state);
    });

    setupDiscordButton();
    handleDiscordRedirect();

    window.addEventListener("focus", () => quizzringState.refreshPresence());
    setInterval(() => quizzringState.refreshPresence(), 30000);
  </script>
</body>
</html>
